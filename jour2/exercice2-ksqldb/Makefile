.PHONY: help start stop clean logs status ksql topics consume generate install-deps

help:
	@echo "ksqlDB Exercice - Commandes disponibles:"
	@echo "  make start           - DÃ©marrer l'infrastructure (Kafka + ksqlDB + Kafka UI)"
	@echo "  make stop            - ArrÃªter tous les services"
	@echo "  make clean           - Supprimer tous les conteneurs et volumes"
	@echo "  make logs            - Afficher les logs de tous les services"
	@echo "  make status          - VÃ©rifier le statut des services"
	@echo ""
	@echo "ksqlDB:"
	@echo "  make ksql            - Se connecter au CLI ksqlDB"
	@echo "  make ksql-setup      - Charger le fichier setup.sql dans ksqlDB"
	@echo "  make ksql-queries    - Afficher les requÃªtes en cours"
	@echo "  make ksql-streams    - Lister les streams crÃ©Ã©s"
	@echo "  make ksql-tables     - Lister les tables crÃ©Ã©es"
	@echo ""
	@echo "DonnÃ©es:"
	@echo "  make generate        - GÃ©nÃ©rer tous les Ã©vÃ©nements de test"
	@echo "  make generate-continuous - GÃ©nÃ©rer des Ã©vÃ©nements en continu"
	@echo "  make topics          - Lister les topics Kafka"
	@echo "  make consume         - Consommer le topic user_events"

start:
	@echo "ðŸš€ DÃ©marrage de l'infrastructure ksqlDB..."
	docker-compose up -d
	@echo "â³ Attente du dÃ©marrage complet (60s)..."
	@sleep 60
	@echo "âœ… Infrastructure dÃ©marrÃ©e!"
	@echo ""
	@echo "   - Kafka Broker: localhost:9092"
	@echo "   - ksqlDB Server: http://localhost:8088"
	@echo "   - Kafka UI: http://localhost:8080"
	@echo ""
	@echo "ðŸ’¡ Prochaines Ã©tapes:"
	@echo "   1. GÃ©nÃ©rer des donnÃ©es: make generate"
	@echo "   2. Charger le setup ksqlDB: make ksql-setup"
	@echo "   3. Se connecter Ã  ksqlDB: make ksql"

stop:
	@echo "ðŸ›‘ ArrÃªt de tous les services..."
	docker-compose down

clean:
	@echo "ðŸ§¹ Nettoyage complet..."
	docker-compose down -v
	@echo "âœ… Nettoyage terminÃ©!"

logs:
	docker-compose logs -f

status:
	@echo "ðŸ“Š Statut des services:"
	@docker-compose ps
	@echo ""
	@echo "ðŸ”· ksqlDB Server:"
	@curl -s http://localhost:8088/info | jq . 2>/dev/null || echo "âŒ ksqlDB non disponible"

ksql:
	@echo "ðŸ”· Connexion au CLI ksqlDB..."
	@echo "ðŸ’¡ Tapez 'exit' ou Ctrl+D pour quitter"
	@echo ""
	docker exec -it ksqldb-cli ksql http://ksqldb-server:8088

ksql-setup:
	@echo "ðŸ“‚ Chargement de queries/setup.sql dans ksqlDB..."
	@docker exec ksqldb-cli ksql http://ksqldb-server:8088 --file /opt/queries/setup.sql
	@echo "âœ… Setup terminÃ©!"
	@echo "ðŸ’¡ VÃ©rifiez avec: make ksql-streams"

ksql-queries:
	@echo "ðŸ“‹ RequÃªtes ksqlDB en cours:"
	@docker exec ksqldb-cli ksql http://ksqldb-server:8088 --execute "SHOW QUERIES;"

ksql-streams:
	@echo "ðŸ“‹ Streams ksqlDB:"
	@docker exec ksqldb-cli ksql http://ksqldb-server:8088 --execute "SHOW STREAMS;"

ksql-tables:
	@echo "ðŸ“‹ Tables ksqlDB:"
	@docker exec ksqldb-cli ksql http://ksqldb-server:8088 --execute "SHOW TABLES;"

generate:
	@echo "ðŸ“Š GÃ©nÃ©ration des Ã©vÃ©nements de test..."
	./scripts/generate_events.sh
	@echo ""
	@echo "ðŸ’¡ VÃ©rifiez avec: make consume"

generate-continuous:
	@echo "ðŸ”„ GÃ©nÃ©ration continue d'Ã©vÃ©nements (Ctrl+C pour arrÃªter)..."
	./scripts/generate_events.sh continuous

topics:
	@echo "ðŸ“‹ Liste des topics Kafka:"
	@docker exec kafka kafka-topics --bootstrap-server localhost:9092 --list
	@echo ""
	@echo "ðŸ“Š DÃ©tail du topic user_events:"
	@docker exec kafka kafka-topics --bootstrap-server localhost:9092 \
		--describe --topic user_events 2>/dev/null || echo "Topic pas encore crÃ©Ã©"

consume:
	@echo "ðŸ“© Consommation du topic user_events:"
	@docker exec kafka kafka-console-consumer \
		--bootstrap-server localhost:9092 \
		--topic user_events \
		--from-beginning \
		--max-messages 10 \
		--timeout-ms 5000
