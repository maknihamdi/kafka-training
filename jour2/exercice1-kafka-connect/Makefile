.PHONY: help start stop clean logs status connectors create-source create-sink delete-source delete-sink db-connect db-query topics

help:
	@echo "Kafka Connect - Commandes disponibles:"
	@echo "  make start           - D√©marrer l'infrastructure compl√®te"
	@echo "  make stop            - Arr√™ter tous les services"
	@echo "  make clean           - Supprimer tous les conteneurs"
	@echo "  make logs            - Afficher les logs de tous les services"
	@echo "  make status          - V√©rifier le statut des services"
	@echo ""
	@echo "Connecteurs:"
	@echo "  make connectors      - Lister tous les connecteurs"
	@echo "  make create-source   - Cr√©er le source connector (FileStream)"
	@echo "  make create-sink     - Cr√©er le sink connector (JDBC)"
	@echo "  make delete-source   - Supprimer le source connector"
	@echo "  make delete-sink     - Supprimer le sink connector"
	@echo ""
	@echo "Base de donn√©es:"
	@echo "  make db-connect      - Se connecter √† PostgreSQL"
	@echo "  make db-query        - Requ√™ter la table messages"
	@echo ""
	@echo "Kafka:"
	@echo "  make topics          - Lister les topics Kafka"
	@echo "  make consume         - Consommer le topic db-source_data"
	@echo "  make add-data        - Ajouter une donn√©e dans source_data"

start:
	@echo "üöÄ D√©marrage de l'infrastructure Kafka Connect..."
	docker-compose up -d
	@echo "‚è≥ Attente du d√©marrage complet (90s)..."
	@sleep 90
	@echo "‚úÖ Infrastructure d√©marr√©e!"
	@echo "   - Kafka UI: http://localhost:8080"
	@echo "   - Kafka Connect API: http://localhost:8083"
	@echo "   - PostgreSQL: localhost:5432 (user: kafka, password: kafka123)"

stop:
	@echo "üõë Arr√™t de tous les services..."
	docker-compose down

clean:
	@echo "üßπ Nettoyage complet..."
	docker-compose down -v
	@echo "‚úÖ Nettoyage termin√©!"

logs:
	docker-compose logs -f

status:
	@echo "üìä Statut des services:"
	@docker-compose ps
	@echo ""
	@echo "üîå Kafka Connect:"
	@curl -s http://localhost:8083/ | jq . 2>/dev/null || echo "‚ùå Kafka Connect non disponible"

connectors:
	@echo "üìã Liste des connecteurs:"
	@curl -s http://localhost:8083/connectors | jq . || echo "‚ùå Impossible de lister les connecteurs"
	@echo ""
	@echo "D√©tails des connecteurs:"
	@for connector in $$(curl -s http://localhost:8083/connectors | jq -r '.[]' 2>/dev/null); do \
		echo ""; \
		echo "üìå $$connector:"; \
		curl -s http://localhost:8083/connectors/$$connector/status | jq .; \
	done

create-source:
	@echo "üì• Cr√©ation du Source Connector (JDBC Source)..."
	@curl -X POST http://localhost:8083/connectors \
		-H "Content-Type: application/json" \
		-d @config/source-jdbc-connector.json \
		| jq . || echo "‚ùå Erreur lors de la cr√©ation"
	@echo ""
	@echo "‚úÖ Source connector cr√©√©! V√©rifiez avec: make connectors"

create-sink:
	@echo "üì§ Cr√©ation du Sink Connector (JDBC)..."
	@curl -X POST http://localhost:8083/connectors \
		-H "Content-Type: application/json" \
		-d @config/sink-jdbc-connector.json \
		| jq . || echo "‚ùå Erreur lors de la cr√©ation"
	@echo ""
	@echo "‚úÖ Sink connector cr√©√©! V√©rifiez avec: make connectors"

delete-source:
	@echo "üóëÔ∏è  Suppression du Source Connector..."
	@curl -X DELETE http://localhost:8083/connectors/jdbc-source
	@echo ""
	@echo "‚úÖ Source connector supprim√©!"

delete-sink:
	@echo "üóëÔ∏è  Suppression du Sink Connector..."
	@curl -X DELETE http://localhost:8083/connectors/jdbc-sink
	@echo ""
	@echo "‚úÖ Sink connector supprim√©!"

db-connect:
	@echo "üêò Connexion √† PostgreSQL..."
	@docker exec -it postgres psql -U kafka -d kafka_sink

db-query:
	@echo "üîç Contenu de la table source_data:"
	@docker exec -it postgres psql -U kafka -d kafka_sink -c "SELECT * FROM source_data ORDER BY id;"
	@echo ""
	@echo "üîç Contenu de la table sink_data:"
	@docker exec -it postgres psql -U kafka -d kafka_sink -c "SELECT * FROM sink_data ORDER BY id;"

topics:
	@echo "üìã Liste des topics Kafka:"
	@docker exec kafka kafka-topics --bootstrap-server localhost:9092 --list
	@echo ""
	@echo "üìä D√©tails du topic db-source_data:"
	@docker exec kafka kafka-topics --bootstrap-server localhost:9092 --describe --topic db-source_data 2>/dev/null || echo "Topic pas encore cr√©√©"

consume:
	@echo "üì© Consommation du topic db-source_data:"
	@docker exec kafka kafka-console-consumer \
		--bootstrap-server localhost:9092 \
		--topic db-source_data \
		--from-beginning \
		--max-messages 10 \
		--timeout-ms 5000

add-data:
	@echo "‚ûï Ajout de nouvelles donn√©es dans source_data..."
	@docker exec -it postgres psql -U kafka -d kafka_sink -c "INSERT INTO source_data (message) VALUES ('New message added at $(shell date)');"
	@echo "‚úÖ Donn√©e ajout√©e! Attendez 5s et v√©rifiez avec: make db-query"
