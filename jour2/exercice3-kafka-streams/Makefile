.PHONY: help start stop clean build run-producer run-streams logs status topics consume init-data topology topology-describe

help:
	@echo "Kafka Streams Exercice - Commandes disponibles:"
	@echo ""
	@echo "Infrastructure:"
	@echo "  make start           - DÃ©marrer Kafka et Kafka UI"
	@echo "  make stop            - ArrÃªter tous les services"
	@echo "  make clean           - Supprimer tous les conteneurs et volumes"
	@echo "  make status          - VÃ©rifier le statut des services"
	@echo "  make logs            - Afficher les logs"
	@echo ""
	@echo "Build & Run:"
	@echo "  make build           - Compiler les projets Maven"
	@echo "  make run-producer    - Lancer le producer (port 8081)"
	@echo "  make run-streams     - Lancer Kafka Streams (port 8082)"
	@echo ""
	@echo "DonnÃ©es:"
	@echo "  make init-data       - Initialiser les profils utilisateurs"
	@echo "  make generate        - GÃ©nÃ©rer 20 Ã©vÃ©nements de test"
	@echo "  make generate-100    - GÃ©nÃ©rer 100 Ã©vÃ©nements"
	@echo ""
	@echo "Topics Kafka:"
	@echo "  make topics          - Lister tous les topics"
	@echo "  make describe-topics - DÃ©tails des topics (compaction, partitions)"
	@echo "  make consume-events  - Consommer user-events"
	@echo "  make consume-filtered - Consommer filtered-events"
	@echo "  make consume-profiles - Consommer user-profiles"
	@echo ""
	@echo "Topologie Kafka Streams:"
	@echo "  make topology        - Afficher la topologie (JSON)"
	@echo "  make topology-describe - Description de la topologie (texte)"

start:
	@echo "ðŸš€ DÃ©marrage de Kafka..."
	docker compose up -d
	@echo "â³ Attente du dÃ©marrage (30s)..."
	@sleep 30
	@echo "âœ… Infrastructure dÃ©marrÃ©e!"
	@echo ""
	@echo "ðŸ’¡ Prochaines Ã©tapes:"
	@echo "   1. Compiler: make build"
	@echo "   2. Lancer le producer: make run-producer"
	@echo "   3. Initialiser les profils: make init-data"
	@echo "   4. GÃ©nÃ©rer des Ã©vÃ©nements: make generate"
	@echo "   5. Lancer Kafka Streams: make run-streams"
	@echo ""
	@echo "âš ï¸  Ports utilisÃ©s:"
	@echo "   - Kafka: localhost:9092"
	@echo "   - Kafka UI: http://localhost:8080"
	@echo "   - Producer API: http://localhost:8081"
	@echo "   - Streams API: http://localhost:8082"

stop:
	@echo "ðŸ›‘ ArrÃªt des services..."
	docker compose down

clean:
	@echo "ðŸ§¹ Nettoyage complet..."
	docker compose down -v
	@echo "âœ… Nettoyage terminÃ©!"

logs:
	docker compose logs -f

status:
	@echo "ðŸ“Š Statut des services:"
	@docker compose ps

build:
	@echo "ðŸ”¨ Compilation des projets Maven..."
	mvn clean install
	@echo "âœ… Compilation terminÃ©e!"

run-producer:
	@echo "ðŸš€ Lancement du Producer (port 8081)..."
	@echo "   API disponible sur: http://localhost:8081"
	cd producer && mvn spring-boot:run

run-streams:
	@echo "ðŸŒŠ Lancement de Kafka Streams (port 8082)..."
	@echo "   VÃ©rifiez les logs pour voir la topologie"
	cd streams && mvn spring-boot:run

init-data:
	@echo "ðŸ‘¥ Initialisation des profils utilisateurs..."
	@curl -X POST http://localhost:8081/api/profiles/init
	@echo ""
	@echo "âœ… 5 profils crÃ©Ã©s dans le topic user-profiles (compactÃ©)"

generate:
	@echo "ðŸ“Š GÃ©nÃ©ration de 20 Ã©vÃ©nements..."
	@curl -X POST "http://localhost:8081/api/events/generate?count=20"
	@echo ""

generate-100:
	@echo "ðŸ“Š GÃ©nÃ©ration de 100 Ã©vÃ©nements..."
	@curl -X POST "http://localhost:8081/api/events/generate?count=100"
	@echo ""

topics:
	@echo "ðŸ“‹ Liste des topics Kafka:"
	@docker exec kafka kafka-topics --bootstrap-server localhost:9092 --list

describe-topics:
	@echo "ðŸ“Š DÃ©tails des topics:"
	@echo ""
	@echo "=== user-events ==="
	@docker exec kafka kafka-topics --bootstrap-server localhost:9092 \
		--describe --topic user-events
	@echo ""
	@echo "=== user-profiles (COMPACTED) ==="
	@docker exec kafka kafka-topics --bootstrap-server localhost:9092 \
		--describe --topic user-profiles
	@echo ""
	@echo "=== filtered-events ==="
	@docker exec kafka kafka-topics --bootstrap-server localhost:9092 \
		--describe --topic filtered-events 2>/dev/null || echo "Topic pas encore crÃ©Ã©"

consume-events:
	@echo "ðŸ“© Consommation de user-events (10 derniers):"
	@docker exec kafka kafka-console-consumer \
		--bootstrap-server localhost:9092 \
		--topic user-events \
		--from-beginning \
		--max-messages 10 \
		--timeout-ms 5000

consume-filtered:
	@echo "ðŸ“© Consommation de filtered-events (PURCHASE uniquement):"
	@docker exec kafka kafka-console-consumer \
		--bootstrap-server localhost:9092 \
		--topic filtered-events \
		--from-beginning \
		--max-messages 10 \
		--timeout-ms 5000

consume-profiles:
	@echo "ðŸ“© Consommation de user-profiles (topic compactÃ©):"
	@docker exec kafka kafka-console-consumer \
		--bootstrap-server localhost:9092 \
		--topic user-profiles \
		--from-beginning \
		--property print.key=true \
		--property key.separator=":" \
		--timeout-ms 5000

topology:
	@echo "ðŸ“Š Topologie Kafka Streams (JSON):"
	@curl -s http://localhost:8082/api/topology | jq '.' 2>/dev/null || \
		curl -s http://localhost:8082/api/topology

topology-describe:
	@echo "ðŸ“Š Description de la topologie Kafka Streams:"
	@echo ""
	@curl -s http://localhost:8082/api/topology/describe
	@echo ""
	@echo ""
	@echo "ðŸ’¡ Pour visualiser graphiquement:"
	@echo "   1. Copier la sortie ci-dessus"
	@echo "   2. Aller sur: https://zz85.github.io/kafka-streams-viz/"
	@echo "   3. Coller la description dans l'outil"

show-topology:
	curl -s http://localhost:8082/api/topology/describe
	open "https://zz85.github.io/kafka-streams-viz/#topology=$$topology"
