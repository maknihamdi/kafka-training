.PHONY: help start stop restart clean logs logs-all ui status shell-1 shell-2 shell-3 stop-broker-1 stop-broker-2 stop-broker-3 start-broker-1 start-broker-2 start-broker-3

help: ## Afficher l'aide
	@echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
	@echo "â•‘  Exercice 3 - RÃ©plication et RÃ©silience           â•‘"
	@echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
	@echo ""
	@echo "Commandes disponibles:"
	@grep -E '^[a-zA-Z_-]+:.*?## .*$$' $(MAKEFILE_LIST) | awk 'BEGIN {FS = ":.*?## "}; {printf "  \033[36m%-20s\033[0m %s\n", $$1, $$2}'

start: ## DÃ©marrer le cluster Kafka (3 brokers)
	@echo "ğŸš€ DÃ©marrage du cluster Kafka (3 brokers)..."
	docker-compose up -d
	@echo "âœ… Cluster Kafka dÃ©marrÃ©!"
	@echo ""
	@echo "â³ Attente du dÃ©marrage complet (30 secondes)..."
	@sleep 30
	@echo ""
	@echo "ğŸ“Š Kafka UI: http://localhost:8080"
	@echo "ğŸ”§ Brokers:"
	@echo "   - Broker 1 (kafka-1): localhost:9092"
	@echo "   - Broker 2 (kafka-2): localhost:9093"
	@echo "   - Broker 3 (kafka-3): localhost:9094"

stop: ## ArrÃªter le cluster Kafka
	@echo "ğŸ›‘ ArrÃªt du cluster Kafka..."
	docker-compose down
	@echo "âœ… Cluster arrÃªtÃ©!"

restart: stop start ## RedÃ©marrer le cluster Kafka

clean: ## Supprimer les volumes et tout nettoyer
	@echo "ğŸ§¹ Nettoyage complet..."
	docker-compose down -v
	@echo "âœ… Nettoyage terminÃ©!"

logs: ## Afficher les logs de tous les brokers
	docker-compose logs -f kafka-1 kafka-2 kafka-3

logs-all: ## Afficher tous les logs (brokers + UI)
	docker-compose logs -f

ui: ## Ouvrir Kafka UI dans le navigateur
	@echo "ğŸŒ Ouverture de Kafka UI..."
	@sleep 2
	@open http://localhost:8080 2>/dev/null || xdg-open http://localhost:8080 2>/dev/null || echo "Ouvrez http://localhost:8080 dans votre navigateur"

status: ## Afficher le statut du cluster
	@echo "ğŸ“Š Statut du cluster Kafka:"
	@echo ""
	@docker-compose ps
	@echo ""
	@echo "ğŸ“‹ Topics disponibles:"
	@docker exec kafka-1 kafka-topics --bootstrap-server localhost:9092 --list 2>/dev/null || echo "âš ï¸  Kafka n'est pas encore prÃªt ou aucun topic crÃ©Ã©"

shell-1: ## Ouvrir un shell dans kafka-1
	@echo "ğŸ”§ Ouverture d'un shell dans kafka-1..."
	@docker exec -it kafka-1 /bin/bash

shell-2: ## Ouvrir un shell dans kafka-2
	@echo "ğŸ”§ Ouverture d'un shell dans kafka-2..."
	@docker exec -it kafka-2 /bin/bash

shell-3: ## Ouvrir un shell dans kafka-3
	@echo "ğŸ”§ Ouverture d'un shell dans kafka-3..."
	@docker exec -it kafka-3 /bin/bash

stop-broker-1: ## ArrÃªter kafka-1 (pour tester la rÃ©silience)
	@echo "ğŸ›‘ ArrÃªt de kafka-1..."
	docker-compose stop kafka-1
	@echo "âœ… kafka-1 arrÃªtÃ©!"

stop-broker-2: ## ArrÃªter kafka-2 (pour tester la rÃ©silience)
	@echo "ğŸ›‘ ArrÃªt de kafka-2..."
	docker-compose stop kafka-2
	@echo "âœ… kafka-2 arrÃªtÃ©!"

stop-broker-3: ## ArrÃªter kafka-3 (pour tester la rÃ©silience)
	@echo "ğŸ›‘ ArrÃªt de kafka-3..."
	docker-compose stop kafka-3
	@echo "âœ… kafka-3 arrÃªtÃ©!"

start-broker-1: ## RedÃ©marrer kafka-1
	@echo "ğŸš€ RedÃ©marrage de kafka-1..."
	docker-compose start kafka-1
	@echo "âœ… kafka-1 redÃ©marrÃ©!"

start-broker-2: ## RedÃ©marrer kafka-2
	@echo "ğŸš€ RedÃ©marrage de kafka-2..."
	docker-compose start kafka-2
	@echo "âœ… kafka-2 redÃ©marrÃ©!"

start-broker-3: ## RedÃ©marrer kafka-3
	@echo "ğŸš€ RedÃ©marrage de kafka-3..."
	docker-compose start kafka-3
	@echo "âœ… kafka-3 redÃ©marrÃ©!"